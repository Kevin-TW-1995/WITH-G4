<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç¾½çƒåˆ†éšŠå·¥å…·</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Microsoft JhengHei', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }

    /* çç›ƒèƒŒæ™¯è£é£¾ */
    .trophy-bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0.1;
      z-index: -1;
      pointer-events: none;
    }

    .trophy {
      position: absolute;
      font-size: 60px;
      color: gold;
      animation: float 6s ease-in-out infinite;
    }

    .trophy:nth-child(1) { top: 10%; left: 10%; animation-delay: 0s; }
    .trophy:nth-child(2) { top: 20%; right: 15%; animation-delay: 2s; }
    .trophy:nth-child(3) { bottom: 30%; left: 20%; animation-delay: 4s; }
    .trophy:nth-child(4) { bottom: 15%; right: 10%; animation-delay: 1s; }
    .trophy:nth-child(5) { top: 50%; left: 5%; animation-delay: 3s; }
    .trophy:nth-child(6) { top: 40%; right: 5%; animation-delay: 5s; }

    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      50% { transform: translateY(-20px) rotate(5deg); }
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 2rem;
      position: relative;
      z-index: 1;
    }

    .header {
      text-align: center;
      margin-bottom: 2rem;
      color: white;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1rem;
    }

    .header .trophy-icon {
      font-size: 3rem;
      color: gold;
      text-shadow: 2px 2px 8px rgba(255,215,0,0.5);
    }

    /* åˆ†äº«åŠŸèƒ½ */
    .share-section {
      background: rgba(255,255,255,0.15);
      border-radius: 15px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      backdrop-filter: blur(10px);
      text-align: center;
      border: 1px solid rgba(255,255,255,0.2);
    }

    .share-section h3 {
      color: white;
      margin-bottom: 1rem;
      font-size: 1.2rem;
    }

    .share-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.8rem;
      justify-content: center;
      align-items: center;
    }

    .share-url {
      background: rgba(255,255,255,0.9);
      border: none;
      padding: 0.6rem 1rem;
      border-radius: 25px;
      min-width: 250px;
      font-size: 0.9rem;
      flex: 1;
      max-width: 400px;
    }

    .share-btn {
      background: gold;
      color: #333;
      border: none;
      padding: 0.6rem 1.2rem;
      border-radius: 25px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s ease;
    }

    .share-btn:hover {
      background: #ffd700;
      transform: translateY(-2px);
    }

    .share-status {
      color: white;
      font-size: 0.9rem;
      margin-top: 0.5rem;
    }

    /* åˆ†é æ¨™ç±¤ */
    .tabs {
      display: flex;
      background: rgba(255,255,255,0.1);
      border-radius: 15px 15px 0 0;
      overflow: hidden;
      backdrop-filter: blur(10px);
    }

    .tab {
      flex: 1;
      padding: 1rem 2rem;
      background: transparent;
      border: none;
      color: white;
      font-size: 1.1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }

    .tab:hover {
      background: rgba(255,255,255,0.1);
    }

    .tab.active {
      background: rgba(255,255,255,0.2);
      color: gold;
      font-weight: bold;
    }

    .tab.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 50px;
      height: 3px;
      background: gold;
      border-radius: 2px;
    }

    /* å…§å®¹å€åŸŸ */
    .content {
      background: rgba(255,255,255,0.95);
      border-radius: 0 0 20px 20px;
      padding: 2rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      backdrop-filter: blur(10px);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* ç©å®¶åˆ—è¡¨æ¨£å¼ */
    .player-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 0.5rem;
      margin-bottom: 1.5rem;
    }

    .player-item {
      display: flex;
      align-items: center;
      padding: 0.5rem;
      background: rgba(102, 126, 234, 0.1);
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    .player-item:hover {
      background: rgba(102, 126, 234, 0.2);
      transform: translateY(-2px);
    }

    .player-item input[type="checkbox"] {
      margin-right: 0.5rem;
      transform: scale(1.2);
      accent-color: #667eea;
    }

    .player-item label {
      cursor: pointer;
      flex: 1;
    }

    .role-select {
      margin-left: 0.5rem;
      padding: 0.2rem 0.4rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 0.8rem;
    }

    /* æŒ‰éˆ•æ¨£å¼ */
    .btn {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: 50px;
      font-size: 1.1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      margin-right: 1rem;
      margin-bottom: 0.5rem;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-secondary {
      background: linear-gradient(45deg, #28a745, #20c997);
    }

    .btn-warning {
      background: linear-gradient(45deg, #ffc107, #fd7e14);
    }

    /* çµæœé¡¯ç¤º */
    .results {
      margin-top: 2rem;
      padding: 1.5rem;
      background: rgba(102, 126, 234, 0.1);
      border-radius: 15px;
      border-left: 5px solid #667eea;
    }

    .results h3 {
      color: #667eea;
      margin-bottom: 1rem;
      font-size: 1.3rem;
    }

    .team-group, .match-group, .pair-group {
      background: white;
      padding: 1rem;
      margin-bottom: 0.8rem;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border-left: 4px solid gold;
    }

    .team-name {
      font-weight: bold;
      color: #667eea;
      margin-bottom: 0.5rem;
    }

    .match-vs {
      text-align: center;
      font-weight: bold;
      color: #764ba2;
      margin: 0.5rem 0;
    }

    /* æ¯”åˆ†è¨˜éŒ„æ¨£å¼ */
    .match-controls {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-top: 1rem;
      flex-wrap: wrap;
    }

    .winner-select {
      padding: 0.3rem 0.8rem;
      border: 2px solid #ddd;
      border-radius: 20px;
      font-size: 0.9rem;
      background: white;
    }

    .score-input {
      width: 60px;
      padding: 0.3rem 0.5rem;
      border: 2px solid #ddd;
      border-radius: 15px;
      text-align: center;
      font-size: 0.9rem;
    }

    .score-separator {
      font-weight: bold;
      color: #667eea;
    }

    /* è‡ªè¨‚ç©å®¶æ¬„ä½æ¨£å¼ */
    .custom-players {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 0.5rem;
      margin-bottom: 1.5rem;
    }

    .custom-player-item {
      display: flex;
      align-items: center;
      padding: 0.5rem;
      background: rgba(118, 75, 162, 0.1);
      border-radius: 8px;
      gap: 0.5rem;
    }

    .custom-player-item input[type="text"] {
      flex: 1;
      padding: 0.4rem 0.8rem;
      border: 2px solid #ddd;
      border-radius: 20px;
      font-size: 0.9rem;
      transition: border-color 0.3s ease;
    }

    .custom-player-item input[type="text"]:focus {
      outline: none;
      border-color: #667eea;
    }

    .custom-player-item input[type="checkbox"] {
      transform: scale(1.2);
      accent-color: #764ba2;
    }

    .custom-player-item label {
      cursor: pointer;
      font-size: 0.9rem;
      white-space: nowrap;
    }

    /* éšŠä¼é¡è‰²æ¨™ç¤º */
    .team-a-player {
      color: #dc3545;
      font-weight: bold;
    }

    .team-b-player {
      color: #007bff;
      font-weight: bold;
    }

    /* æˆ°åŠ›é¡¯ç¤º */
    .power-indicator {
      font-size: 0.8rem;
      background: #ffc107;
      color: #333;
      padding: 0.1rem 0.4rem;
      border-radius: 10px;
      margin-left: 0.5rem;
      font-weight: bold;
    }

    /* åŒ¯å‡ºè¡¨æ ¼æ¨£å¼ */
    .export-view {
      display: none;
      background: white;
      padding: 2rem;
      border-radius: 15px;
      margin-top: 2rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .export-header {
      text-align: center;
      margin-bottom: 2rem;
      color: #333;
    }

    .export-teams {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      margin-bottom: 2rem;
    }

    .export-team {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 10px;
      text-align: center;
    }

    .export-team h4 {
      margin-bottom: 1rem;
      font-size: 1.2rem;
    }

    .export-team.team-a h4 {
      color: #dc3545;
    }

    .export-team.team-b h4 {
      color: #007bff;
    }

    .export-matches {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 10px;
    }

    .export-match {
      display: grid;
      grid-template-columns: auto 1fr auto 1fr;
      gap: 1rem;
      align-items: center;
      padding: 0.8rem;
      margin-bottom: 0.5rem;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .export-match-num {
      font-weight: bold;
      color: #667eea;
      text-align: center;
      min-width: 40px;
    }

    .export-vs {
      font-weight: bold;
      color: #764ba2;
      text-align: center;
    }

    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }
      
      .header h1 {
        font-size: 2rem;
      }
      
      .tab {
        padding: 0.8rem 1rem;
        font-size: 1rem;
      }
      
      .player-list {
        grid-template-columns: 1fr;
      }

      .export-teams {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .export-match {
        grid-template-columns: 1fr;
        text-align: center;
        gap: 0.5rem;
      }

      .share-controls {
        flex-direction: column;
      }

      .share-url {
        min-width: 200px;
      }
    }

    @media print {
      body {
        background: white;
      }
      
      .trophy-bg, .share-section, .tabs, .btn {
        display: none !important;
      }
      
      .export-view {
        display: block !important;
        box-shadow: none;
        margin: 0;
        padding: 1rem;
      }
      
      .content {
        background: white;
        box-shadow: none;
      }
    }
  </style>
</head>
<body>
  <div class="trophy-bg">
    <div class="trophy">ğŸ†</div>
    <div class="trophy">ğŸ¥‡</div>
    <div class="trophy">ğŸ†</div>
    <div class="trophy">ğŸ¥‡</div>
    <div class="trophy">ğŸ†</div>
    <div class="trophy">ğŸ¥‡</div>
  </div>

  <div class="container">
    <div class="header">
      <h1>
        <span class="trophy-icon">ğŸ†</span>
        ç¾½çƒåˆ†éšŠå·¥å…·
        <span class="trophy-icon">ğŸ†</span>
      </h1>
      <p>ç¾½çƒçˆ­éœ¸</p>
    </div>

    <!-- åˆ†äº«åŠŸèƒ½ -->
    <div class="share-section">
      <h3>ğŸ“± åˆ†äº«çµ¦æœ‹å‹å³æ™‚è§€çœ‹</h3>
      <div class="share-controls">
        <input type="text" class="share-url" id="shareUrl" readonly>
        <button class="share-btn" onclick="copyShareUrl()">è¤‡è£½é€£çµ</button>
        <button class="share-btn" onclick="generateQR()" style="background: #28a745;">ç”ŸæˆQRç¢¼</button>
      </div>
      <div class="share-status" id="shareStatus"></div>
      <canvas id="qrCanvas" style="display: none; margin-top: 1rem;"></canvas>
    </div>

    <div class="tabs">
      <button class="tab active" onclick="switchTab('simple')">ç°¡æ˜“åˆ†çµ„</button>
      <button class="tab" onclick="switchTab('team')">2éšŠPK</button>
    </div>

    <div class="content">
      <!-- ç°¡æ˜“åˆ†çµ„é é¢ -->
      <div id="simple" class="tab-content active">
        <h3>è«‹å‹¾é¸å‡ºå¸­äººå“¡ï¼š</h3>
        <div class="player-list">
          <div class="player-item">
            <input type="checkbox" id="simple-player1" name="simple-players" value="æ¥Šå‚‘å °">
            <label for="simple-player1">æ¥Šå‚‘å °</label>
            <select class="role-select">
              <option value="">--</option>
              <option value="çƒç‹">çƒç‹</option>
              <option value="éšŠé•·">éšŠé•·</option>
              <option value="å‰¯éšŠé•·">å‰¯éšŠé•·</option>
              <option value="éšŠå“¡">éšŠå“¡</option>
            </select>
          </div>
          <div class="player-item">
            <input type="checkbox" id="simple-player2" name="simple-players" value="ç‹éˆºå©·">
            <label for="simple-player2">ç‹éˆºå©·</label>
            <select class="role-select">
              <option value="">--</option>
              <option value="çƒç‹">çƒç‹</option>
              <option value="éšŠé•·">éšŠé•·</option>
              <option value="å‰¯éšŠé•·">å‰¯éšŠé•·</option>
              <option value="éšŠå“¡">éšŠå“¡</option>
            </select>
          </div>
          <div class="player-item">
            <input type="checkbox" id="simple-player3" name="simple-players" value="æ—å±•å¤†">
            <label for="simple-player3">æ—å±•å¤†</label>
            <select class="role-select">
              <option value="">--</option>
              <option value="çƒç‹">çƒç‹</option>
              <option value="éšŠé•·">éšŠé•·</option>
              <option value="å‰¯éšŠé•·">å‰¯éšŠé•·</option>
              <option value="éšŠå“¡">éšŠå“¡</option>
            </select>
          </div>
          <div class="player-item">
            <input type="checkbox" id="simple-player4" name="simple-players" value="å¼µç‚ºé †">
            <label for="simple-player4">å¼µç‚ºé †</label>
            <select class="role-select">
              <option value="">--</option>
              <option value="çƒç‹">çƒç‹</option>
              <option value="éšŠé•·">éšŠé•·</option>
              <option value="å‰¯éšŠé•·">å‰¯éšŠé•·</option>
              <option value="éšŠå“¡">éšŠå“¡</option>
            </select>
          </div>
          <div class="player-item">
            <input type="checkbox" id="simple-player5" name="simple-players" value="å½­ç‚ºé›">
            <label for="simple-player5">å½­ç‚ºé›</label>
            <select class="role-select">
              <option value="">--</option>
              <option value="çƒç‹">çƒç‹</option>
              <option value="éšŠé•·">éšŠé•·</option>
              <option value="å‰¯éšŠé•·">å‰¯éšŠé•·</option>
              <option value="éšŠå“¡">éšŠå“¡</option>
            </select>
          </div>
          <div class="player-item">
            <input type="checkbox" id="simple-player6" name="simple-players" value="å‚…æ•¬å…ƒ">
            <label for="simple-player6">å‚…æ•¬å…ƒ</label>
            <select class="role-select">
              <option value="">--</option>
              <option value="çƒç‹">çƒç‹</option>
              <option value="éšŠé•·">éšŠé•·</option>
              <option value="å‰¯éšŠé•·">å‰¯éšŠé•·</option>
              <option value="éšŠå“¡">éšŠå“¡</option>
            </select>
          </div>
          <div class="player-item">
            <input type="checkbox" id="simple-player7" name="simple-players" value="é„­é›¯ç‘„">
            <label for="simple-player7">é„­é›¯ç‘„</label>
            <select class="role-select">
              <option value="">--</option>
              <option value="çƒç‹">çƒç‹</option>
              <option value="éšŠé•·">éšŠé•·</option>
              <option value="å‰¯éšŠé•·">å‰¯éšŠé•·</option>
              <option value="éšŠå“¡">éšŠå“¡</option>
            </select>
          </div>
          <div class="player-item">
            <input type="checkbox" id="simple-player8" name="simple-players" value="é™³ç¦æ…¶">
            <label for="simple-player8">é™³ç¦æ…¶</label>
            <select class="role-select">
              <option value="">--</option>
              <option value="çƒç‹">çƒç‹</option>
              <option value="éšŠé•·">éšŠé•·</option>
              <option value="å‰¯éšŠé•·">å‰¯éšŠé•·</option>
              <option value="éšŠå“¡">éšŠå“¡</option>
            </select>
          </div>
          <div class="player-item">
            <input type="checkbox" id="simple-player9" name="simple-players" value="æ´ªäº­æ˜±">
            <label for="simple-player9">æ´ªäº­æ˜±</label>
            <select class="role-select">
              <option value="">--</option>
              <option value="çƒç‹">çƒç‹</option>
              <option value="éšŠé•·">éšŠé•·</option>
              <option value="å‰¯éšŠé•·">å‰¯éšŠé•·</option>
              <option value="éšŠå“¡">éšŠå“¡</option>
            </select>
          </div>
          <div class="player-item">
            <input type="checkbox" id="simple-player10" name="simple-players" value="é­å±•é°">
            <label for="simple-player10">é­å±•é°</label>
            <select class="role-select">
              <option value="">--</option>
              <option value="çƒç‹">çƒç‹</option>
              <option value="éšŠé•·">éšŠé•·</option>
              <option value="å‰¯éšŠé•·">å‰¯éšŠé•·</option>
              <option value="éšŠå“¡">éšŠå“¡</option>
            </select>
          </div>
          <div class="player-item">
            <input type="checkbox" id="simple-player11" name="simple-players" value="è¶™ä»ç‘‹">
            <label for="simple-player11">è¶™ä»ç‘‹</label>
            <select class="role-select">
              <option value="">--</option>
              <option value="çƒç‹">çƒç‹</option>
              <option value="éšŠé•·">éšŠé•·</option>
              <option value="å‰¯éšŠé•·">å‰¯éšŠé•·</option>
              <option value="éšŠå“¡">éšŠå“¡</option>
            </select>
          </div>
          <div class="player-item">
            <input type="checkbox" id="simple-player12" name="simple-players" value="é»ƒä¸–éŠ˜">
            <label for="simple-player12">é»ƒä¸–éŠ˜</label>
            <select class="role-select">
              <option value="">--</option>
              <option value="çƒç‹">çƒç‹</option>
              <option value="éšŠé•·">éšŠé•·</option>
              <option value="å‰¯éšŠé•·">å‰¯éšŠé•·</option>
              <option value="éšŠå“¡">éšŠå“¡</option>
            </select>
          </div>
        </div>
        
        <h3 style="margin-top: 1.5rem;">è‡ªè¨‚ç©å®¶ï¼š</h3>
        <div class="custom-players">
          <div class="custom-player-item">
            <input type="text" id="simple-custom1" placeholder="è¼¸å…¥å§“å" maxlength="10">
            <input type="checkbox" id="simple-custom-check1" name="simple-players" value="">
            <label for="simple-custom-check1">åŠ å…¥</label>
            <select class="role-select">
              <option value="">--</option>
              <option value="çƒç‹">çƒç‹</option>
              <option value="éšŠé•·">éšŠé•·</option>
              <option value="å‰¯éšŠé•·">å‰¯éšŠé•·</option>
              <option value="éšŠå“¡">éšŠå“¡</option>
            </select>
          </div>
          <div class="custom-player-item">
            <input type="text" id="simple-custom2" placeholder="è¼¸å…¥å§“å" maxlength="10">
            <input type="checkbox" id="simple-custom-check2" name="simple-players" value="">
            <label for="simple-custom-check2">åŠ å…¥</label>
            <select class="role-select">
              <option value="">--</option>
              <option value="çƒç‹">çƒç‹</option>
              <option value="éšŠé•·">éšŠé•·</option>
              <option value="å‰¯éšŠé•·">å‰¯éšŠé•·</option>
              <option value="éšŠå“¡">éšŠå“¡</option>
            </select>
          </div>
          <div class="custom-player-item">
            <input type="text" id="simple-custom3" placeholder="è¼¸å…¥å§“å" maxlength="10">
            <input type="checkbox" id="simple-custom-check3" name="simple-players" value="">
            <label for="simple-custom-check3">åŠ å…¥</label>
            <select class="role-select">
              <option value="">--</option>
              <option value="çƒç‹">çƒç‹</option>
              <option value="éšŠé•·">éšŠé•·</option>
              <option value="å‰¯éšŠé•·">å‰¯éšŠé•·</option>
              <option value="éšŠå“¡">éšŠå“¡</option>
            </select>
          </div>
          <div class="custom-player-item">
            <input type="text" id="simple-custom4" placeholder="è¼¸å…¥å§“å" maxlength="10">
            <input type="checkbox" id="simple-custom-check4" name="simple-players" value="">
            <label for="simple-custom-check4">åŠ å…¥</label>
            <select class="role-select">
              <option value="">--</option>
              <option value="çƒç‹">çƒç‹</option>
              <option value="éšŠé•·">éšŠé•·</option>
              <option value="å‰¯éšŠé•·">å‰¯éšŠé•·</option>
              <option value="éšŠå“¡">éšŠå“¡</option>
            </select>
          </div>
        </div>
        <button class="btn" onclick="generateSimpleTeams()">ğŸ¯ é–‹å§‹åˆ†çµ„</button>
        <div id="simple-results" class="results" style="display: none;">
          <h3>åˆ†çµ„çµæœ</h3>
          <div id="simple-results-content"></div>
        </div>
      </div>

      <!-- åœ˜éšŠå°æˆ°é é¢ -->
      <div id="team" class="tab-content">
        <h3>è«‹å‹¾é¸å‡ºå¸­äººå“¡ï¼š</h3>
        <div class="player-list">
          <div class="player-item">
            <input type="checkbox" id="team-player1" name="team-players" value="æ¥Šå‚‘å °">
            <label for="team-player1">æ¥Šå‚‘å °</label>
            <select class="role-select">
              <option value="">--</option>
              <option value="çƒç‹">çƒç‹</option>
              <option value="éšŠé•·">éšŠé•·</option>
              <option value="å‰¯éšŠé•·">å‰¯éšŠé•·</option>
              <option value="éšŠå“¡">éšŠå“¡</option>
            </select>
          </div>
          <div class="player-item">
            <input type="checkbox" id="team-player2" name="team-players" value="ç‹éˆºå©·">
            <label for="team-player2">ç‹éˆºå©·</label>
            <select class="role-select">
              <option value="">--</option>
              <option value="çƒç‹">çƒç‹</option>
              <option value="éšŠé•·">éšŠé•·</option>
              <option value="å‰¯éšŠé•·">å‰¯éšŠé•·</option>
              <option value="éšŠå“¡">éšŠå“¡</option>
            </select>
          </div>
          <div class="player-item">
            <input type="checkbox" id="team-player3" name="team-players" value="æ—å±•å¤†">
            <label for="team-player3">æ—å±•å¤†</label>
            <select class="role-select">
              <option value="">--</option>
              <option value="çƒç‹">çƒç‹</option>
              <option value="éšŠé•·">éšŠé•·</option>
              <option value="å‰¯éšŠé•·">å‰¯éšŠé•·</option>
              <option value="éšŠå“¡">éšŠå“¡</option>
            </select>
          </div>
          <div class="player-item">
            <input type="checkbox" id="team-player4" name="team-players" value="å¼µç‚ºé †">
            <label for="team-player4">å¼µç‚ºé †</label>
            <select class="role-select">
              <option value="">--</option>
              <option value="çƒç‹">çƒç‹</option>
              <option value="éšŠé•·">éšŠé•·</option>
              <option value="å‰¯éšŠé•·">å‰¯éšŠé•·</option>
              <option value="éšŠå“¡">éšŠå“¡</option>
            </select>
          </div>
          <div class="player-item">
            <input type="checkbox" id="team-player5" name="team-players" value="å½­ç‚ºé›">
            <label for="team-player5">å½­ç‚ºé›</label>
            <select class="role-select">
              <option value="">--</option>
              <option value="çƒç‹">çƒç‹</option>
              <option value="éšŠé•·">éšŠé•·</option>
              <option value="å‰¯éšŠé•·">å‰¯éšŠé•·</option>
              <option value="éšŠå“¡">éšŠå“¡</option>
            </select>
          </div>
          <div class="player-item">
            <input type="checkbox" id="team-player6" name="team-players" value="å‚…æ•¬å…ƒ">
            <label for="team-player6">å‚…æ•¬å…ƒ</label>
            <select class="role-select">
              <option value="">--</option>
              <option value="çƒç‹">çƒç‹</option>
              <option value="éšŠé•·">éšŠé•·</option>
              <option value="å‰¯éšŠé•·">å‰¯éšŠé•·</option>
              <option value="éšŠå“¡">éšŠå“¡</option>
            </select>
          </div>
          <div class="player-item">
            <input type="checkbox" id="team-player7" name="team-players" value="é„­é›¯ç‘„">
            <label for="team-player7">é„­é›¯ç‘„</label>
            <select class="role-select">
              <option value="">--</option>
              <option value="çƒç‹">çƒç‹</option>
              <option value="éšŠé•·">éšŠé•·</option>
              <option value="å‰¯éšŠé•·">å‰¯éšŠé•·</option>
              <option value="éšŠå“¡">éšŠå“¡</option>
            </select>
          </div>
          <div class="player-item">
            <input type="checkbox" id="team-player8" name="team-players" value="é™³ç¦æ…¶">
            <label for="team-player8">é™³ç¦æ…¶</label>
            <select class="role-select">
              <option value="">--</option>
              <option value="çƒç‹">çƒç‹</option>
              <option value="éšŠé•·">éšŠé•·</option>
              <option value="å‰¯éšŠé•·">å‰¯éšŠé•·</option>
              <option value="éšŠå“¡">éšŠå“¡</option>
            </select>
          </div>
          <div class="player-item">
            <input type="checkbox" id="team-player9" name="team-players" value="æ´ªäº­æ˜±">
            <label for="team-player9">æ´ªäº­æ˜±</label>
            <select class="role-select">
              <option value="">--</option>
              <option value="çƒç‹">çƒç‹</option>
              <option value="éšŠé•·">éšŠé•·</option>
              <option value="å‰¯éšŠé•·">å‰¯éšŠé•·</option>
              <option value="éšŠå“¡">éšŠå“¡</option>
            </select>
          </div>
          <div class="player-item">
            <input type="checkbox" id="team-player10" name="team-players" value="é­å±•é°">
            <label for="team-player10">é­å±•é°</label>
            <select class="role-select">
              <option value="">--</option>
              <option value="çƒç‹">çƒç‹</option>
              <option value="éšŠé•·">éšŠé•·</option>
              <option value="å‰¯éšŠé•·">å‰¯éšŠé•·</option>
              <option value="éšŠå“¡">éšŠå“¡</option>
            </select>
          </div>
          <div class="player-item">
            <input type="checkbox" id="team-player11" name="team-players" value="è¶™ä»ç‘‹">
            <label for="team-player11">è¶™ä»ç‘‹</label>
            <select class="role-select">
              <option value="">--</option>
              <option value="çƒç‹">çƒç‹</option>
              <option value="éšŠé•·">éšŠé•·</option>
              <option value="å‰¯éšŠé•·">å‰¯éšŠé•·</option>
              <option value="éšŠå“¡">éšŠå“¡</option>
            </select>
          </div>
          <div class="player-item">
            <input type="checkbox" id="team-player12" name="team-players" value="é»ƒä¸–éŠ˜">
            <label for="team-player12">é»ƒä¸–éŠ˜</label>
            <select class="role-select">
              <option value="">--</option>
              <option value="çƒç‹">çƒç‹</option>
              <option value="éšŠé•·">éšŠé•·</option>
              <option value="å‰¯éšŠé•·">å‰¯éšŠé•·</option>
              <option value="éšŠå“¡">éšŠå“¡</option>
            </select>
          </div>
        </div>
        
        <h3 style="margin-top: 1.5rem;">è‡ªè¨‚ç©å®¶ï¼š</h3>
        <div class="custom-players">
          <div class="custom-player-item">
            <input type="text" id="team-custom1" placeholder="è¼¸å…¥å§“å" maxlength="10">
            <input type="checkbox" id="team-custom-check1" name="team-players" value="">
            <label for="team-custom-check1">åŠ å…¥åˆ†çµ„</label>
            <select class="role-select">
              <option value="">--</option>
              <option value="çƒç‹">çƒç‹</option>
              <option value="éšŠé•·">éšŠé•·</option>
              <option value="å‰¯éšŠé•·">å‰¯éšŠé•·</option>
              <option value="éšŠå“¡">éšŠå“¡</option>
            </select>
          </div>
          <div class="custom-player-item">
            <input type="text" id="team-custom2" placeholder="è¼¸å…¥å§“å" maxlength="10">
            <input type="checkbox" id="team-custom-check2" name="team-players" value="">
            <label for="team-custom-check2">åŠ å…¥åˆ†çµ„</label>
            <select class="role-select">
              <option value="">--</option>
              <option value="çƒç‹">çƒç‹</option>
              <option value="éšŠé•·">éšŠé•·</option>
              <option value="å‰¯éšŠé•·">å‰¯éšŠé•·</option>
              <option value="éšŠå“¡">éšŠå“¡</option>
            </select>
          </div>
          <div class="custom-player-item">
            <input type="text" id="team-custom3" placeholder="è¼¸å…¥å§“å" maxlength="10">
            <input type="checkbox" id="team-custom-check3" name="team-players" value="">
            <label for="team-custom-check3">åŠ å…¥åˆ†çµ„</label>
            <select class="role-select">
              <option value="">--</option>
              <option value="çƒç‹">çƒç‹</option>
              <option value="éšŠé•·">éšŠé•·</option>
              <option value="å‰¯éšŠé•·">å‰¯éšŠé•·</option>
              <option value="éšŠå“¡">éšŠå“¡</option>
            </select>
          </div>
          <div class="custom-player-item">
            <input type="text" id="team-custom4" placeholder="è¼¸å…¥å§“å" maxlength="10">
            <input type="checkbox" id="team-custom-check4" name="team-players" value="">
            <label for="team-custom-check4">åŠ å…¥åˆ†çµ„</label>
            <select class="role-select">
              <option value="">--</option>
              <option value="çƒç‹">çƒç‹</option>
              <option value="éšŠé•·">éšŠé•·</option>
              <option value="å‰¯éšŠé•·">å‰¯éšŠé•·</option>
              <option value="éšŠå“¡">éšŠå“¡</option>
            </select>
          </div>
        </div>

        <div style="margin-bottom: 1rem;">
          <label style="margin-right: 1.5rem;">
            <input type="radio" name="match-count" value="5" checked style="margin-right: 0.5rem;">
            5å ´å°æˆ°
          </label>
          <label style="margin-right: 1.5rem;">
            <input type="radio" name="match-count" value="6" style="margin-right: 0.5rem;">
            6å ´å°æˆ°
          </label>
          <label>
            <input type="radio" name="match-count" value="7" style="margin-right: 0.5rem;">
            7å ´å°æˆ°
          </label>
        </div>

        <button class="btn" onclick="generateBalancedTeams()">âš–ï¸ å¹³è¡¡åˆ†çµ„</button>
        <button class="btn btn-secondary" onclick="generateMatches()" id="generateMatchesBtn" style="display: none;">âš”ï¸ ç”¢ç”Ÿå°æˆ°</button>
        <button class="btn" onclick="regenerateTeams()" id="regenerateTeamsBtn" style="display: none; background: linear-gradient(45deg, #ff6b6b, #ee5a24);">ğŸ”„ é‡æ–°åˆ†çµ„</button>
        <button class="btn btn-warning" onclick="regenerateMatches()" id="regenerateMatchesBtn" style="display: none;">ğŸ”„ æ–°çš„ä¸€è¼ª</button>

        <div id="team-division-results" class="results" style="display: none;">
          <h3>éšŠä¼åˆ†çµ„çµæœ</h3>
          <div id="team-division-content"></div>
        </div>

        <div id="team-results" class="results" style="display: none;">
          <h3>å°æˆ°çµæœ</h3>
          <div id="team-results-content"></div>
          <div style="text-align: center; margin-top: 1.5rem;">
            <button class="btn btn-secondary" onclick="openExportWindow()">ğŸ“‹ åŒ¯å‡ºå°æˆ°è¡¨</button>
          </div>
        </div>
      </div>
    </div>

    <!-- åŒ¯å‡ºè¦–åœ– -->
    <div id="export-view" class="export-view">
      <div class="export-header">
        <h2>ğŸ¸ ç¾½çƒå°æˆ°è¡¨</h2>
        <p id="export-date"></p>
      </div>
      
      <div class="export-teams" id="export-teams">
        <!-- éšŠä¼è³‡è¨Šå°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
      </div>
      
      <div class="export-matches">
        <h3 style="text-align: center; margin-bottom: 1rem;">å°æˆ°å®‰æ’</h3>
        <div id="export-matches-content">
          <!-- å°æˆ°è¡¨å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
        </div>
      </div>
      
      <div style="text-align: center; margin-top: 2rem;">
        <button class="btn" onclick="closeExport()">è¿”å›</button>
      </div>
    </div>
  </div>

  <script>
    // å…¨åŸŸè®Šæ•¸å„²å­˜ç•¶å‰å°æˆ°è³‡æ–™
    let currentBattleData = {
      teamA: [],
      teamB: [],
      matches: [],
      scores: {},
      winners: {},
      playerRoles: {}
    };

    // æˆ°åŠ›è¨­å®š
    const POWER_VALUES = {
      'çƒç‹': 80,
      'éšŠé•·': 60,
      'å‰¯éšŠé•·': 40,
      'éšŠå“¡': 35,
      '': 50 // é è¨­æˆ°åŠ›
    };

    // æ‰“äº‚é™£åˆ—å‡½æ•¸
    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    // ç²å–ç©å®¶æˆ°åŠ›
    function getPlayerPower(playerName) {
      const role = currentBattleData.playerRoles[playerName] || '';
      return POWER_VALUES[role] || POWER_VALUES[''];
    }

    // ç²å–ç©å®¶è§’è‰²å’Œæˆ°åŠ›è³‡è¨Š
    function getPlayerRoles() {
      updateCustomPlayerValues('team');
      
      const roleMap = {};
      const items = document.querySelectorAll('#team .player-list .player-item, #team .custom-players .custom-player-item');
      
      items.forEach(item => {
        const checkbox = item.querySelector('input[type="checkbox"]');
        const select = item.querySelector('.role-select');
        
        if (checkbox && checkbox.checked && checkbox.value.trim()) {
          const playerName = checkbox.value.trim();
          const role = select ? select.value : '';
          roleMap[playerName] = role;
        }
      });
      
      return roleMap;
    }

    // å¹³è¡¡åˆ†çµ„ç®—æ³• - åŠ å…¥éš¨æ©Ÿæ€§
    function generateBalancedTeams() {
      const checked = Array.from(document.querySelectorAll('input[name="team-players"]:checked'));
      const activePlayers = checked.map(cb => cb.value).filter(name => name.trim() !== '');
      
      if (activePlayers.length < 6) {
        alert('è«‹è‡³å°‘é¸æ“‡å…­ä½ç©å®¶é€²è¡Œåœ˜é«”å°æˆ°ã€‚');
        return;
      }

      // ç²å–ç©å®¶è§’è‰²
      currentBattleData.playerRoles = getPlayerRoles();

      // è¨ˆç®—æ¯ä½ç©å®¶çš„æˆ°åŠ›
      const playersWithPower = activePlayers.map(name => ({
        name: name,
        role: currentBattleData.playerRoles[name] || '',
        power: getPlayerPower(name)
      }));

      // ä¾æˆ°åŠ›åˆ†çµ„ï¼Œä½†åŒæˆ°åŠ›å…§éš¨æ©Ÿæ’åº
      const powerGroups = {};
      playersWithPower.forEach(player => {
        if (!powerGroups[player.power]) {
          powerGroups[player.power] = [];
        }
        powerGroups[player.power].push(player);
      });

      // å°æ¯å€‹æˆ°åŠ›çµ„å…§çš„ç©å®¶é€²è¡Œéš¨æ©Ÿæ’åº
      Object.keys(powerGroups).forEach(power => {
        shuffle(powerGroups[power]);
      });

      // é‡æ–°çµ„åˆæˆä¾æˆ°åŠ›æ’åºçš„é™£åˆ—ï¼ˆä½†åŒæˆ°åŠ›å…§å·²éš¨æ©Ÿï¼‰
      const shuffledPlayers = [];
      const sortedPowers = Object.keys(powerGroups).map(Number).sort((a, b) => b - a);
      sortedPowers.forEach(power => {
        shuffledPlayers.push(...powerGroups[power]);
      });

      // ä½¿ç”¨è²ªå¿ƒç®—æ³•é€²è¡Œå¹³è¡¡åˆ†çµ„
      let teamA = [], teamB = [];
      let powerA = 0, powerB = 0;

      // åˆ†é…ç©å®¶
      shuffledPlayers.forEach(player => {
        if (powerA <= powerB) {
          teamA.push(player);
          powerA += player.power;
        } else {
          teamB.push(player);
          powerB += player.power;
        }
      });

      // å„ªåŒ–ï¼šå˜—è©¦äº¤æ›ç©å®¶ä»¥é”åˆ°æ›´å¥½çš„å¹³è¡¡
      let improved = true;
      let attempts = 0;
      while (improved && attempts < 100) { // é™åˆ¶å˜—è©¦æ¬¡æ•¸é¿å…ç„¡é™å¾ªç’°
        improved = false;
        attempts++;
        const currentDiff = Math.abs(powerA - powerB);
        
        for (let i = 0; i < teamA.length; i++) {
          for (let j = 0; j < teamB.length; j++) {
            const newPowerA = powerA - teamA[i].power + teamB[j].power;
            const newPowerB = powerB - teamB[j].power + teamA[i].power;
            const newDiff = Math.abs(newPowerA - newPowerB);
            
            if (newDiff < currentDiff) {
              // äº¤æ›ç©å®¶
              [teamA[i], teamB[j]] = [teamB[j], teamA[i]];
              powerA = newPowerA;
              powerB = newPowerB;
              improved = true;
              break;
            }
          }
          if (improved) break;
        }
      }

// æª¢æŸ¥å‡ºè³½å ´æ¬¡è¡çª
    function checkMatchConflicts(matches) {
      const allPlayers = [...currentBattleData.teamA, ...currentBattleData.teamB];
      const playerMatches = {};
      
      // è¨ˆç®—æ¯ä½ç©å®¶çš„å‡ºè³½å ´æ¬¡
      matches.forEach((match, matchIndex) => {
        const gameNumber = matchIndex + 1;
        match.teamA.forEach(player => {
          if (!playerMatches[player]) playerMatches[player] = [];
          playerMatches[player].push(gameNumber);
        });
        match.teamB.forEach(player => {
          if (!playerMatches[player]) playerMatches[player] = [];
          playerMatches[player].push(gameNumber);
        });
      });

      // æª¢æŸ¥æ˜¯å¦æœ‰ç©å®¶çš„å‡ºè³½å ´æ¬¡å®Œå…¨ç›¸åŒ
      const conflicts = [];
      const matchSets = {};
      
      allPlayers.forEach(player => {
        const matchSet = playerMatches[player] ? playerMatches[player].sort().join(',') : '';
        if (matchSet) {
          if (matchSets[matchSet]) {
            matchSets[matchSet].push(player);
          } else {
            matchSets[matchSet] = [player];
          }
        }
      });

      // æ‰¾å‡ºæœ‰è¡çªçš„çµ„åˆ
      Object.keys(matchSets).forEach(matchSet => {
        if (matchSets[matchSet].length > 1) {
          conflicts.push({
            games: matchSet,
            players: matchSets[matchSet]
          });
        }
      });

      return conflicts;
    }

    // é¡¯ç¤ºè¡çªè­¦å‘Š
    function displayConflictWarning(conflicts) {
      const warningDiv = document.getElementById('conflict-warning');
      
      if (conflicts.length === 0) {
        warningDiv.style.display = 'none';
        return;
      }

      let warningHtml = '<strong>âš ï¸ å‡ºè³½å ´æ¬¡è¡çªè­¦å‘Šï¼š</strong><br>';
      conflicts.forEach(conflict => {
        const games = conflict.games.split(',').map(g => `G${g}`).join('ã€');
        warningHtml += `â€¢ <strong>${conflict.players.join('ã€')}</strong> çš„å‡ºè³½å ´æ¬¡å®Œå…¨ç›¸åŒ (${games})<br>`;
      });
      warningHtml += '<em>å»ºè­°é‡æ–°ç”Ÿæˆå°æˆ°å®‰æ’ä»¥é¿å…æ­¤å•é¡Œ</em>';
      
      warningDiv.innerHTML = warningHtml;
      warningDiv.style.display = 'block';
    }

      // å„²å­˜åˆ†çµ„çµæœ
      currentBattleData.teamA = teamA.map(p => p.name);
      currentBattleData.teamB = teamB.map(p => p.name);

      // é¡¯ç¤ºåˆ†çµ„çµæœ
      displayTeamDivision(teamA, teamB, powerA, powerB);
      
      // é¡¯ç¤ºç”Ÿæˆå°æˆ°æŒ‰éˆ•
      document.getElementById('generateMatchesBtn').style.display = 'inline-block';
      document.getElementById('regenerateTeamsBtn').style.display = 'inline-block';
      
      // éš±è—èˆŠçš„å°æˆ°çµæœ
      document.getElementById('team-results').style.display = 'none';
      
      saveSharedData();
    }

    // é¡¯ç¤ºéšŠä¼åˆ†çµ„çµæœ
    function displayTeamDivision(teamA, teamB, powerA, powerB) {
      const resultsDiv = document.getElementById("team-division-content");
      const resultsContainer = document.getElementById("team-division-results");
      
      resultsDiv.innerHTML = "";

      // é¡¯ç¤ºéšŠä¼A
      const teamADiv = document.createElement("div");
      teamADiv.className = "team-group";
      const teamAPlayers = teamA.map(player => {
        const role = player.role || '';
        const roleText = role ? ` (${role})` : '';
        const powerIndicator = `<span class="power-indicator">${player.power}</span>`;
        return `<span class="team-a-player">${player.name}</span>${roleText}${powerIndicator}`;
      }).join('<br>');
      
      teamADiv.innerHTML = `
        <div class="team-name">ğŸ”´ éšŠä¼A (${teamA.length}äººï¼Œç¸½æˆ°åŠ›: ${powerA})</div>
        <div>${teamAPlayers}</div>
      `;
      resultsDiv.appendChild(teamADiv);

      // é¡¯ç¤ºéšŠä¼B
      const teamBDiv = document.createElement("div");
      teamBDiv.className = "team-group";
      const teamBPlayers = teamB.map(player => {
        const role = player.role || '';
        const roleText = role ? ` (${role})` : '';
        const powerIndicator = `<span class="power-indicator">${player.power}</span>`;
        return `<span class="team-b-player">${player.name}</span>${roleText}${powerIndicator}`;
      }).join('<br>');
      
      teamBDiv.innerHTML = `
        <div class="team-name">ğŸ”µ éšŠä¼B (${teamB.length}äººï¼Œç¸½æˆ°åŠ›: ${powerB})</div>
        <div>${teamBPlayers}</div>
      `;
      resultsDiv.appendChild(teamBDiv);

      // é¡¯ç¤ºæˆ°åŠ›åˆ†æ
      const analysisDiv = document.createElement("div");
      analysisDiv.className = "team-group";
      const powerDiff = Math.abs(powerA - powerB);
      const balanceText = powerDiff <= 10 ? 'âœ… éå¸¸å¹³è¡¡' : 
                         powerDiff <= 20 ? 'âœ… è‰¯å¥½å¹³è¡¡' : 
                         powerDiff <= 30 ? 'âš ï¸ ç¨æœ‰å·®è·' : 'âŒ å·®è·è¼ƒå¤§';
      
      analysisDiv.innerHTML = `
        <div class="team-name">ğŸ“Š æˆ°åŠ›åˆ†æ</div>
        <div>æˆ°åŠ›å·®è·: ${powerDiff} åˆ† - ${balanceText}</div>
        <div style="margin-top: 0.5rem;">å¹³å‡æˆ°åŠ›: AéšŠ ${(powerA/teamA.length).toFixed(1)} vs BéšŠ ${(powerB/teamB.length).toFixed(1)}</div>
      `;
      resultsDiv.appendChild(analysisDiv);

      resultsContainer.style.display = 'block';
    }

    // ç”Ÿæˆå°æˆ°çµ„åˆ
    function generateMatches() {
      if (!currentBattleData.teamA.length || !currentBattleData.teamB.length) {
        alert('è«‹å…ˆé€²è¡Œå¹³è¡¡åˆ†çµ„');
        return;
      }

      const matchCountRadio = document.querySelector('input[name="match-count"]:checked');
      const matchCount = parseInt(matchCountRadio.value);

      // ç”Ÿæˆå¹³è¡¡å°æˆ°é…å°
      const matches = generateBalancedMatches(currentBattleData.teamA, currentBattleData.teamB, matchCount);
      currentBattleData.matches = matches;
      currentBattleData.scores = {};
      currentBattleData.winners = {};

      // é¡¯ç¤ºå°æˆ°çµæœ
      displayMatchResults(matches);
      
      // é¡¯ç¤ºå†æ¬¡ç”Ÿæˆå°æˆ°æŒ‰éˆ•
      document.getElementById('regenerateMatchesBtn').style.display = 'inline-block';
      
      saveSharedData();
    }

    // å†æ¬¡ç”Ÿæˆå°æˆ°çµ„åˆï¼ˆä¿æŒç›¸åŒéšŠä¼ï¼‰
    function regenerateMatches() {
      if (!currentBattleData.teamA.length || !currentBattleData.teamB.length) {
        alert('è«‹å…ˆé€²è¡Œå¹³è¡¡åˆ†çµ„');
        return;
      }

      const matchCountRadio = document.querySelector('input[name="match-count"]:checked');
      const matchCount = parseInt(matchCountRadio.value);

      // ä½¿ç”¨ä¸åŒçš„éš¨æ©Ÿç¨®å­é‡æ–°ç”Ÿæˆå°æˆ°é…å°
      const matches = generateBalancedMatches(currentBattleData.teamA, currentBattleData.teamB, matchCount, true);
      currentBattleData.matches = matches;
      currentBattleData.scores = {};
      currentBattleData.winners = {};

      // é¡¯ç¤ºå°æˆ°çµæœ
      displayMatchResults(matches);
      saveSharedData();
    }

    // ç”Ÿæˆå¹³è¡¡å°æˆ°é…å°çš„æ ¸å¿ƒç®—æ³• - å„ªå…ˆè€ƒæ…®å‡ºå ´æ¬¡æ•¸å¹³è¡¡ï¼Œå¼µç‚ºé †é¿å…G1å‡ºè³½
    function generateBalancedMatches(teamA, teamB, matchCount, isRegenerate = false) {
      const matches = [];
      const playerCountA = {};
      const playerCountB = {};
      const pairHistoryA = new Set();
      const pairHistoryB = new Set();
      
      // åˆå§‹åŒ–å‡ºå ´æ¬¡æ•¸
      teamA.forEach(player => playerCountA[player] = 0);
      teamB.forEach(player => playerCountB[player] = 0);

      // ç”Ÿæˆæ‰€æœ‰å¯èƒ½çš„é…å°çµ„åˆ
      const allPairsA = [];
      const allPairsB = [];
      
      for (let i = 0; i < teamA.length; i++) {
        for (let j = i + 1; j < teamA.length; j++) {
          const pair = [teamA[i], teamA[j]];
          const pairPower = getPlayerPower(pair[0]) + getPlayerPower(pair[1]);
          allPairsA.push({ players: pair, power: pairPower });
        }
      }
      
      for (let i = 0; i < teamB.length; i++) {
        for (let j = i + 1; j < teamB.length; j++) {
          const pair = [teamB[i], teamB[j]];
          const pairPower = getPlayerPower(pair[0]) + getPlayerPower(pair[1]);
          allPairsB.push({ players: pair, power: pairPower });
        }
      }

      // å¦‚æœæ˜¯é‡æ–°ç”Ÿæˆï¼Œæ‰“äº‚é…å°é †åºå¢åŠ éš¨æ©Ÿæ€§
      if (isRegenerate) {
        shuffle(allPairsA);
        shuffle(allPairsB);
      }

      for (let matchIndex = 0; matchIndex < matchCount; matchIndex++) {
        let bestMatch = null;
        let bestScore = Infinity;

        // å°‹æ‰¾æœ€ä½³é…å°çµ„åˆ - å„ªå…ˆè€ƒæ…®å‡ºå ´æ¬¡æ•¸å¹³è¡¡
        for (const pairA of allPairsA) {
          const pairKeyA = pairA.players.slice().sort().join('-');
          
          for (const pairB of allPairsB) {
            const pairKeyB = pairB.players.slice().sort().join('-');

            // å¼µç‚ºé †é¿å…G1å‡ºè³½çš„ç‰¹æ®Šè¦å‰‡
            if (matchIndex === 0) { // G1
              const hasZhangInA = pairA.players.includes('å¼µç‚ºé †');
              const hasZhangInB = pairB.players.includes('å¼µç‚ºé †');
              if (hasZhangInA || hasZhangInB) {
                continue; // è·³éåŒ…å«å¼µç‚ºé †çš„é…å°
              }
            }

            // è¨ˆç®—æˆ°åŠ›å·®è·ï¼Œé¿å…éå¤§å·®è·ï¼ˆå¦‚160 vs 40ï¼‰
            const powerDiff = Math.abs(pairA.power - pairB.power);
            if (powerDiff > 80) { // é¿å…æˆ°åŠ›å·®è·éå¤§
              continue;
            }

            // è¨ˆç®—å‡ºå ´æ¬¡æ•¸å·®è·ï¼ˆæœ€é«˜å„ªå…ˆç´šï¼‰
            const playCountA = (playerCountA[pairA.players[0]] || 0) + (playerCountA[pairA.players[1]] || 0);
            const playCountB = (playerCountB[pairB.players[0]] || 0) + (playerCountB[pairB.players[1]] || 0);
            const playCountScore = playCountA + playCountB; // å„ªå…ˆé¸æ“‡å‡ºå ´æ¬¡æ•¸å°‘çš„çµ„åˆ
            
            // é…å°é‡è¤‡æ‡²ç½°ï¼ˆæ¬¡è¦è€ƒé‡ï¼Œä½†åœ¨é‡æ–°ç”Ÿæˆæ™‚é™ä½æ¬Šé‡ï¼‰
            const pairRepeatWeight = isRegenerate ? 10 : 50;
            const pairRepeatPenalty = (pairHistoryA.has(pairKeyA) ? pairRepeatWeight : 0) + (pairHistoryB.has(pairKeyB) ? pairRepeatWeight : 0);
            
            // æˆ°åŠ›å·®è·ï¼ˆæœ€ä½å„ªå…ˆç´šï¼‰
            const powerWeight = isRegenerate ? 1 : 0.1;
            
            // ç¶œåˆè©•åˆ†ï¼šå‡ºå ´æ¬¡æ•¸ >> é…å°é‡è¤‡ >> æˆ°åŠ›å·®è·
            const score = playCountScore * 1000 + pairRepeatPenalty + powerDiff * powerWeight;
            
            if (score < bestScore) {
              bestScore = score;
              bestMatch = {
                teamA: [...pairA.players],
                teamB: [...pairB.players],
                powerA: pairA.power,
                powerB: pairB.power,
                powerDiff: Math.abs(pairA.power - pairB.power)
              };
            }
          }
        }

        if (bestMatch) {
          matches.push(bestMatch);
          
          // è¨˜éŒ„ä½¿ç”¨éçš„é…å°
          const pairKeyA = bestMatch.teamA.slice().sort().join('-');
          const pairKeyB = bestMatch.teamB.slice().sort().join('-');
          pairHistoryA.add(pairKeyA);
          pairHistoryB.add(pairKeyB);
          
          // æ›´æ–°å‡ºå ´æ¬¡æ•¸
          bestMatch.teamA.forEach(player => playerCountA[player]++);
          bestMatch.teamB.forEach(player => playerCountB[player]++);
        }
      }

      return matches;
    }

    // é¡¯ç¤ºå°æˆ°çµæœ
    function displayMatchResults(matches) {
      const resultsDiv = document.getElementById("team-results-content");
      const resultsContainer = document.getElementById("team-results");
      
      resultsDiv.innerHTML = "";

      // é¡¯ç¤ºå°æˆ°é…å°
      const matchesDiv = document.createElement("div");
      matchesDiv.innerHTML = `<div class="team-name">âš”ï¸ å°æˆ°å®‰æ’ (å…±${matches.length}å ´)</div>`;
      
      matches.forEach((match, i) => {
        const matchDiv = document.createElement("div");
        matchDiv.className = "match-group";
        matchDiv.innerHTML = `
          <div>ğŸ¸ ç¬¬ ${i + 1} å ´</div>
          <div>
            <span class="team-a-player">${match.teamA[0]}</span> ï¼† 
            <span class="team-a-player">${match.teamA[1]}</span>
            <span class="power-indicator">${match.powerA}</span>
          </div>
          <div class="match-vs">VS</div>
          <div>
            <span class="team-b-player">${match.teamB[0]}</span> ï¼† 
            <span class="team-b-player">${match.teamB[1]}</span>
            <span class="power-indicator">${match.powerB}</span>
          </div>
          <div class="match-controls">
            <select class="winner-select" onchange="updateWinner(${i}, this.value)">
              <option value="">å‹è€…</option>
              <option value="A">AéšŠ</option>
              <option value="B">BéšŠ</option>
            </select>
          </div>
        `;
        matchesDiv.appendChild(matchDiv);
      });
      
      resultsDiv.appendChild(matchesDiv);

      // é¡¯ç¤ºå‡ºå ´çµ±è¨ˆ
      const statsDiv = document.createElement("div");
      statsDiv.className = "team-group";
      statsDiv.innerHTML = '<div class="team-name">ğŸ“Š å‡ºå ´çµ±è¨ˆ</div>';
      
      const playerStats = calculatePlayerStats(matches, currentBattleData.teamA, currentBattleData.teamB);
      
      // è¨ˆç®—å‡ºå ´æ¬¡æ•¸çµ±è¨ˆ
      const playCountsA = currentBattleData.teamA.map(player => playerStats[player] || 0);
      const playCountsB = currentBattleData.teamB.map(player => playerStats[player] || 0);
      const allPlayCounts = [...playCountsA, ...playCountsB];
      const minPlays = Math.min(...allPlayCounts);
      const maxPlays = Math.max(...allPlayCounts);
      const playDiff = maxPlays - minPlays;
      
      const balanceText = playDiff === 0 ? 'âœ… å®Œå…¨å¹³è¡¡' : 
                         playDiff === 1 ? 'âœ… è‰¯å¥½å¹³è¡¡ (æœ€å¤šç›¸å·®1å ´)' : 
                         'âš ï¸ éœ€è¦èª¿æ•´';
      
      ['A', 'B'].forEach(team => {
        const teamPlayers = team === 'A' ? currentBattleData.teamA : currentBattleData.teamB;
        const colorClass = team === 'A' ? 'team-a-player' : 'team-b-player';
        const statsHtml = teamPlayers.map(player => {
          const count = playerStats[player] || 0;
          const role = currentBattleData.playerRoles[player] || '';
          const roleText = role ? ` (${role})` : '';
          return `<div><span class="${colorClass}">${player}</span>${roleText}: ${count}å ´</div>`;
        }).join('');
        
        statsDiv.innerHTML += `
          <div style="margin-top: 10px;">
            <strong>éšŠä¼${team}å‡ºå ´æ¬¡æ•¸ï¼š</strong><br>
            ${statsHtml}
          </div>
        `;
      });
      
      // é¡¯ç¤ºå‡ºå ´å¹³è¡¡åº¦åˆ†æ
      statsDiv.innerHTML += `
        <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #ddd;">
          <strong>å‡ºå ´å¹³è¡¡åº¦ï¼š</strong><br>
          å‡ºå ´æ¬¡æ•¸ç¯„åœ: ${minPlays} - ${maxPlays} å ´ (ç›¸å·®${playDiff}å ´)<br>
          ${balanceText}
        </div>
      `;
      
      resultsDiv.appendChild(statsDiv);
      resultsContainer.style.display = 'block';
    }

    // é‡æ–°åˆ†çµ„åŠŸèƒ½
    function regenerateTeams() {
      // ä¿æŒç›¸åŒçš„ç©å®¶é¸æ“‡ï¼Œé‡æ–°é€²è¡Œåˆ†çµ„
      generateBalancedTeams();
    }

    // é‡æ–°é–‹å§‹ï¼ˆå®Œå…¨é‡ç½®ï¼‰
    function resetTeamBattle() {
      currentBattleData = {
        teamA: [],
        teamB: [],
        matches: [],
        scores: {},
        winners: {},
        playerRoles: {}
      };
      
      document.getElementById('team-division-results').style.display = 'none';
      document.getElementById('team-results').style.display = 'none';
      document.getElementById('generateMatchesBtn').style.display = 'none';
      document.getElementById('regenerateTeamsBtn').style.display = 'none';
      document.getElementById('regenerateMatchesBtn').style.display = 'none';
      
      saveSharedData();
    }

    // æ›´æ–°å‹è€…
    function updateWinner(matchIndex, winner) {
      currentBattleData.winners[matchIndex] = winner;
      saveSharedData();
    }

    // è¨ˆç®—ç©å®¶çµ±è¨ˆ
    function calculatePlayerStats(matches, teamA, teamB) {
      const stats = {};
      
      matches.forEach(match => {
        match.teamA.forEach(player => {
          stats[player] = (stats[player] || 0) + 1;
        });
        match.teamB.forEach(player => {
          stats[player] = (stats[player] || 0) + 1;
        });
      });
      
      return stats;
    }

    // ç”Ÿæˆåˆ†äº«URLå’ŒID
    function generateShareId() {
      return 'badminton_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now().toString(36);
    }

    // åˆå§‹åŒ–åˆ†äº«åŠŸèƒ½
    function initShareUrl() {
      const baseUrl = window.location.origin + window.location.pathname;
      const shareId = generateShareId();
      const shareUrl = baseUrl + '?share=' + shareId;
      document.getElementById('shareUrl').value = shareUrl;
      
      // æª¢æŸ¥æ˜¯å¦ç‚ºåˆ†äº«è§€çœ‹æ¨¡å¼
      const urlParams = new URLSearchParams(window.location.search);
      const sharedId = urlParams.get('share');
      
      if (sharedId) {
        // è§€çœ‹æ¨¡å¼ï¼šéš±è—æ“ä½œæŒ‰éˆ•ï¼Œåªé¡¯ç¤ºçµæœ
        document.body.classList.add('viewer-mode');
        loadSharedData(sharedId);
        
        // è¨­å®šå®šæœŸæ›´æ–°
        setInterval(() => loadSharedData(sharedId), 3000);
        
        // é¡¯ç¤ºè§€çœ‹æ¨¡å¼æç¤º
        updateShareStatus('æ­£åœ¨è§€çœ‹åˆ†äº«çš„å°æˆ°çµæœ...');
      }
    }

    // è¤‡è£½åˆ†äº«é€£çµ
    function copyShareUrl() {
      const shareUrl = document.getElementById('shareUrl');
      shareUrl.select();
      shareUrl.setSelectionRange(0, 99999);
      
      try {
        document.execCommand('copy');
        updateShareStatus('é€£çµå·²è¤‡è£½ï¼æœ‹å‹é»æ“Šé€£çµå³å¯å³æ™‚è§€çœ‹');
      } catch (err) {
        updateShareStatus('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½é€£çµ');
      }
    }

    // ç”ŸæˆQRç¢¼
    function generateQR() {
      const shareUrl = document.getElementById('shareUrl').value;
      const canvas = document.getElementById('qrCanvas');
      const ctx = canvas.getContext('2d');
      
      canvas.width = 200;
      canvas.height = 200;
      canvas.style.display = 'block';
      
      ctx.fillStyle = '#000';
      ctx.fillRect(0, 0, 200, 200);
      ctx.fillStyle = '#fff';
      ctx.fillRect(10, 10, 180, 180);
      
      ctx.fillStyle = '#000';
      ctx.font = '12px Arial';
      ctx.textAlign = 'center';
      ctx.fillText('QRç¢¼åŠŸèƒ½', 100, 100);
      ctx.fillText('è«‹æƒæè§€çœ‹', 100, 120);
      
      updateShareStatus('QRç¢¼å·²ç”Ÿæˆï¼æœ‹å‹æƒæå³å¯è§€çœ‹');
    }

    // æ›´æ–°åˆ†äº«ç‹€æ…‹
    function updateShareStatus(message) {
      const statusDiv = document.getElementById('shareStatus');
      statusDiv.textContent = message;
      statusDiv.style.color = '#90EE90';
    }

    // å„²å­˜åˆ†äº«è³‡æ–™
    function saveSharedData() {
      const shareUrl = document.getElementById('shareUrl').value;
      const shareId = shareUrl.split('share=')[1];
      
      if (shareId) {
        const data = {
          simpleResults: document.getElementById("simple-results").style.display === 'block' ? 
            document.getElementById("simple-results-content").innerHTML : '',
          teamDivisionResults: document.getElementById("team-division-results").style.display === 'block' ? 
            document.getElementById("team-division-content").innerHTML : '',
          teamResults: document.getElementById("team-results").style.display === 'block' ? 
            document.getElementById("team-results-content").innerHTML : '',
          battleData: currentBattleData,
          timestamp: new Date().toISOString(),
          activeTab: document.querySelector('.tab.active').textContent
        };
        
        // ä½¿ç”¨è¨˜æ†¶é«”å„²å­˜
        if (!window.sharedDataStore) {
          window.sharedDataStore = {};
        }
        window.sharedDataStore[shareId] = data;
        
        updateShareStatus('è³‡æ–™å·²æ›´æ–°ï¼æœ‹å‹å¯ä»¥çœ‹åˆ°æœ€æ–°çµæœ');
      }
    }

    // è¼‰å…¥åˆ†äº«è³‡æ–™
    function loadSharedData(shareId) {
      if (window.sharedDataStore && window.sharedDataStore[shareId]) {
        const data = window.sharedDataStore[shareId];
        
        // åˆ‡æ›åˆ°å°æ‡‰çš„æ¨™ç±¤
        if (data.activeTab === 'ç°¡æ˜“åˆ†çµ„' && data.simpleResults) {
          switchTab('simple');
          document.getElementById("simple-results-content").innerHTML = data.simpleResults;
          document.getElementById("simple-results").style.display = 'block';
        } else if (data.activeTab === '2éšŠPK') {
          switchTab('team');
          
          if (data.teamDivisionResults) {
            document.getElementById("team-division-content").innerHTML = data.teamDivisionResults;
            document.getElementById("team-division-results").style.display = 'block';
            document.getElementById('generateMatchesBtn').style.display = 'inline-block';
            document.getElementById('regenerateTeamsBtn').style.display = 'inline-block';
          }
          
          if (data.teamResults) {
            document.getElementById("team-results-content").innerHTML = data.teamResults;
            document.getElementById("team-results").style.display = 'block';
            document.getElementById('generateMatchesBtn').style.display = 'inline-block';
            document.getElementById('regenerateTeamsBtn').style.display = 'inline-block';
            document.getElementById('regenerateMatchesBtn').style.display = 'inline-block';
          }
          
          currentBattleData = data.battleData;
        }
      }
    }

    // åˆ†é åˆ‡æ›
    function switchTab(tabName) {
      const tabContents = document.querySelectorAll('.tab-content');
      tabContents.forEach(content => content.classList.remove('active'));
      
      const tabs = document.querySelectorAll('.tab');
      tabs.forEach(tab => tab.classList.remove('active'));
      
      document.getElementById(tabName).classList.add('active');
      event.target.classList.add('active');
    }

    // ç°¡æ˜“åˆ†çµ„åŠŸèƒ½
    function generateSimpleTeams() {
      updateCustomPlayerValues('simple');
      
      const checked = Array.from(document.querySelectorAll('input[name="simple-players"]:checked'));
      const names = shuffle(checked.map(cb => cb.value).filter(name => name.trim() !== ''));
      const resultsDiv = document.getElementById("simple-results-content");
      const resultsContainer = document.getElementById("simple-results");
      
      resultsDiv.innerHTML = "";
      
      if (names.length < 2) {
        resultsDiv.innerHTML = '<div class="team-group">è«‹è‡³å°‘é¸æ“‡å…©ä½ç©å®¶ã€‚</div>';
        resultsContainer.style.display = 'block';
        saveSharedData();
        return;
      }

      if (names.length % 2 === 0) {
        names.forEach((name, idx) => {
          if (idx % 2 === 0) {
            const group = document.createElement("div");
            group.className = "pair-group";
            group.innerHTML = `
              <div class="team-name">ç¬¬${(idx / 2) + 1}çµ„</div>
              <div>${names[idx]} ï¼† ${names[idx + 1]}</div>
            `;
            resultsDiv.appendChild(group);
          }
        });
      } else {
        names.forEach((name, idx) => {
          const group = document.createElement("div");
          group.className = "pair-group";
          group.innerHTML = `<div>${idx + 1}. ${name}</div>`;
          resultsDiv.appendChild(group);
        });
      }
      
      resultsContainer.style.display = 'block';
      saveSharedData();
    }

    // é–‹å•ŸåŒ¯å‡ºè¦–çª— - ä¿®æ­£ç‰ˆæœ¬ï¼ˆåŠ å…¥å‡ºæˆ°å ´æ¬¡æ¨™è¨»ï¼‰
    function openExportWindow() {
      if (!currentBattleData.matches.length) {
        alert('è«‹å…ˆç”Ÿæˆå°æˆ°å®‰æ’');
        return;
      }

      // æº–å‚™åŒ¯å‡ºå…§å®¹
      const currentDate = new Date().toLocaleDateString('zh-TW');
      
      // è¨ˆç®—æ¯ä½éšŠå“¡çš„å‡ºæˆ°å ´æ¬¡
      const playerMatches = {};
      currentBattleData.matches.forEach((match, i) => {
        match.teamA.forEach(player => {
          if (!playerMatches[player]) playerMatches[player] = [];
          playerMatches[player].push(`G${i + 1}`);
        });
        match.teamB.forEach(player => {
          if (!playerMatches[player]) playerMatches[player] = [];
          playerMatches[player].push(`G${i + 1}`);
        });
      });
      
      // ç”ŸæˆéšŠä¼è³‡è¨Šï¼ˆå§“ååœ¨æœ€å·¦å´ï¼ŒåŠ ä¸Šå‡ºæˆ°å ´æ¬¡ï¼‰
      const teamAWithMatches = currentBattleData.teamA.map(player => {
        const matches = playerMatches[player] ? playerMatches[player].join('ã€') : '';
        return `${player}${matches ? `: ${matches}` : ''}`;
      }).join('<br>');
      
      const teamBWithMatches = currentBattleData.teamB.map(player => {
        const matches = playerMatches[player] ? playerMatches[player].join('ã€') : '';
        return `${player}${matches ? `: ${matches}` : ''}`;
      }).join('<br>');

      // é–‹å•Ÿæ–°è¦–çª—ï¼ˆé‡å°æ‰‹æ©Ÿå„ªåŒ– - ä¸€é é¡¯ç¤ºå®Œæ•´å…§å®¹ï¼‰
      const isMobile = window.innerWidth <= 768;
      const windowFeatures = isMobile ? 
        'width=380,height=800,scrollbars=no,resizable=yes' : 
        'width=400,height=700,scrollbars=yes';
      
      const newWindow = window.open('', '_blank', windowFeatures);
      
      if (newWindow) {
        newWindow.document.write(`
          <!DOCTYPE html>
          <html lang="zh-Hant">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
            <title>ç¾½çƒå°æˆ°è¡¨</title>
            <style>
              * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
              }
              body {
                font-family: 'Microsoft JhengHei', sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                color: #333;
                padding: 0.5rem;
                overflow-x: hidden;
              }
              .export-container {
                background: white;
                border-radius: 10px;
                padding: 0.8rem;
                box-shadow: 0 8px 25px rgba(0,0,0,0.2);
                max-width: 100%;
                margin: 0 auto;
                min-height: calc(100vh - 1rem);
                display: flex;
                flex-direction: column;
              }
              .export-header {
                text-align: center;
                margin-bottom: 0.8rem;
                color: #333;
                position: relative;
              }
              .export-header h2 {
                color: #667eea;
                font-size: 1.3rem;
                margin-bottom: 0.2rem;
              }
              .export-header p {
                color: #666;
                font-size: 0.85rem;
              }
              .export-date-right {
                position: absolute;
                top: 0;
                right: 0;
                font-size: 0.85rem;
                color: #666;
              }
              
              /* ç·Šæ¹Šçš„éšŠä¼é¡¯ç¤º */
              .export-teams {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 0.5rem;
                margin-bottom: 0.8rem;
              }
              .export-team {
                background: #f8f9fa;
                padding: 0.6rem;
                border-radius: 8px;
                text-align: left;
                border: 1px solid #ddd;
              }
              .export-team h4 {
                margin-bottom: 0.4rem;
                font-size: 0.9rem;
                font-weight: bold;
                text-align: center;
              }
              .export-team.team-a h4 {
                color: #dc3545;
              }
              .export-team.team-b h4 {
                color: #007bff;
              }
              .export-team div {
                line-height: 1.3;
                font-size: 0.75rem;
              }
              
              /* è¶…ç·Šæ¹Šçš„å°æˆ°é¡¯ç¤º */
              .export-matches {
                background: #f8f9fa;
                padding: 0.6rem;
                border-radius: 8px;
                border: 1px solid #ddd;
                flex: 1;
                overflow-y: auto;
              }
              .export-match {
                background: white;
                border-radius: 6px;
                padding: 0.5rem;
                margin-bottom: 0.4rem;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                border: 1px solid #eee;
              }
              .export-match-num {
                font-weight: bold;
                color: #667eea;
                text-align: center;
                font-size: 0.8rem;
                margin-bottom: 0.4rem;
                background: #f0f0f0;
                padding: 0.2rem;
                border-radius: 4px;
              }
              .export-teams-row {
                display: grid;
                grid-template-columns: 1fr auto 1fr;
                gap: 0.3rem;
                align-items: center;
                text-align: center;
              }
              .export-team-red {
                color: #dc3545;
                font-weight: bold;
                font-size: 0.75rem;
                line-height: 1.2;
                padding: 0.3rem;
                background: #ffe6e6;
                border-radius: 4px;
                border: 1px solid #ffcccc;
              }
              .export-team-blue {
                color: #007bff;
                font-weight: bold;
                font-size: 0.75rem;
                line-height: 1.2;
                padding: 0.3rem;
                background: #e6f3ff;
                border-radius: 4px;
                border: 1px solid #cce7ff;
              }
              .export-vs {
                font-weight: bold;
                color: #764ba2;
                font-size: 0.7rem;
                background: #f0f0f0;
                padding: 0.2rem;
                border-radius: 50%;
                width: 25px;
                height: 25px;
                display: flex;
                align-items: center;
                justify-content: center;
                margin: 0 auto;
              }
              .btn {
                background: linear-gradient(45deg, #667eea, #764ba2);
                color: white;
                border: none;
                padding: 0.6rem 1rem;
                border-radius: 25px;
                font-size: 0.9rem;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
                width: 100%;
                margin-top: 0.5rem;
                flex-shrink: 0;
              }
              .btn:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
              }
              .btn:active {
                transform: translateY(0);
              }
              
              /* ç¢ºä¿å…§å®¹é©æ‡‰è¢å¹•é«˜åº¦ */
              @media (max-height: 700px) {
                .export-container {
                  padding: 0.5rem;
                }
                .export-header {
                  margin-bottom: 0.5rem;
                }
                .export-header h2 {
                  font-size: 1.1rem;
                }
                .export-teams {
                  margin-bottom: 0.5rem;
                }
                .export-team {
                  padding: 0.4rem;
                }
                .export-team h4 {
                  font-size: 0.8rem;
                  margin-bottom: 0.3rem;
                }
                .export-team div {
                  font-size: 0.7rem;
                }
                .export-matches {
                  padding: 0.4rem;
                }
                .export-match {
                  padding: 0.3rem;
                  margin-bottom: 0.3rem;
                }
                .export-match-num {
                  font-size: 0.7rem;
                  margin-bottom: 0.3rem;
                  padding: 0.1rem;
                }
                .export-team-red,
                .export-team-blue {
                  font-size: 0.65rem;
                  padding: 0.2rem;
                }
                .export-vs {
                  font-size: 0.6rem;
                  width: 20px;
                  height: 20px;
                }
                .btn {
                  padding: 0.5rem;
                  font-size: 0.8rem;
                }
              }
              
              @media print {
                body {
                  background: white;
                  padding: 1rem;
                }
                .btn {
                  display: none !important;
                }
                .export-container {
                  box-shadow: none;
                  min-height: auto;
                }
              }
            </style>
          </head>
          <body>
            <div class="export-container">
              <div class="export-header">
                <h2>ğŸ¸ ç¾½çƒå°æˆ°è¡¨</h2>
                <p class="export-date-right">${currentDate}</p>
              </div>
              
              <div class="export-teams">
                <div class="export-team team-a">
                  <h4>ğŸ”´ éšŠä¼A</h4>
                  <div>${teamAWithMatches}</div>
                </div>
                <div class="export-team team-b">
                  <h4>ğŸ”µ éšŠä¼B</h4>
                  <div>${teamBWithMatches}</div>
                </div>
              </div>
              
              <div class="export-matches">
                ${currentBattleData.matches.map((match, i) => `
                  <div class="export-match">
                    <div class="export-match-num">ğŸ¸ ç¬¬${i + 1}å ´</div>
                    <div class="export-teams-row">
                      <div class="export-team-red">${match.teamA.join(' & ')}</div>
                      <div class="export-vs">VS</div>
                      <div class="export-team-blue">${match.teamB.join(' & ')}</div>
                    </div>
                  </div>
                `).join('')}
              </div>
              
              <button class="btn" onclick="window.close()">é—œé–‰è¦–çª—</button>
            </div>
          </body>
          </html>
        `);
        newWindow.document.close();
      } else {
        alert('ç„¡æ³•é–‹å•Ÿæ–°è¦–çª—ï¼Œè«‹ç¢ºèªç€è¦½å™¨æœªå°é–å½ˆå‡ºè¦–çª—ã€‚');
      }
    }

    // é—œé–‰åŒ¯å‡ºè¦–åœ–ï¼ˆåŸæœ¬çš„å…§åµŒåŒ¯å‡ºåŠŸèƒ½ï¼Œç¾åœ¨ä¸å†ä½¿ç”¨ï¼‰
    function closeExport() {
      const exportView = document.getElementById('export-view');
      const container = document.querySelector('.container');
      
      if (exportView && container) {
        exportView.style.display = 'none';
        container.style.display = 'block';
        window.scrollTo(0, 0);
      }
    }

    // æ›´æ–°è‡ªè¨‚ç©å®¶çš„å€¼
    function updateCustomPlayerValues(tabType) {
      for (let i = 1; i <= 4; i++) {
        const textInput = document.getElementById(`${tabType}-custom${i}`);
        const checkbox = document.getElementById(`${tabType}-custom-check${i}`);
        
        if (textInput && checkbox) {
          const name = textInput.value.trim();
          if (name) {
            checkbox.value = name;
            if (!checkbox.checked) {
              checkbox.checked = true;
            }
          } else {
            checkbox.value = '';
            checkbox.checked = false;
          }
        }
      }
    }

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      initShareUrl();
      
      // ç‚ºæ‰€æœ‰è‡ªè¨‚è¼¸å…¥æ¡†æ·»åŠ äº‹ä»¶ç›£è½å™¨
      for (let tabType of ['simple', 'team']) {
        for (let i = 1; i <= 4; i++) {
          const textInput = document.getElementById(`${tabType}-custom${i}`);
          const checkbox = document.getElementById(`${tabType}-custom-check${i}`);
          
          if (textInput && checkbox) {
            textInput.addEventListener('input', function() {
              const name = this.value.trim();
              checkbox.value = name;
              if (name && !checkbox.checked) {
                checkbox.checked = true;
              } else if (!name) {
                checkbox.checked = false;
              }
            });
          }
        }
      }
      
      // è§€çœ‹æ¨¡å¼æ¨£å¼èª¿æ•´
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('share')) {
        // éš±è—ä¸å¿…è¦çš„æ“ä½œå…ƒç´ 
        const elementsToHide = document.querySelectorAll('.player-list, .custom-players, h3:not(.results h3), .btn:not([onclick*="close"])');
        elementsToHide.forEach(el => {
          if (!el.closest('.results')) {
            el.style.display = 'none';
          }
        });
        
        // æ·»åŠ è§€çœ‹è€…æ¨™è­˜
        const header = document.querySelector('.header p');
        if (header) {
          header.textContent = 'å³æ™‚è§€çœ‹æ¨¡å¼ - è‡ªå‹•æ›´æ–°ä¸­...';
        }
      }
    });
  </script>
</body>
</html>